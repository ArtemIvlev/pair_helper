{% extends "base.html" %}

{% block title %}–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h1>
        <a href="{{ url_for('feedback_stats') }}" class="btn btn-info">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ stats.total }}</h5>
                    <p class="card-text">–í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">{{ stats.new }}</h5>
                    <p class="card-text">–ù–æ–≤—ã–µ</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">{{ stats.in_progress }}</h5>
                    <p class="card-text">–í —Ä–∞–±–æ—Ç–µ</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">{{ stats.resolved }}</h5>
                    <p class="card-text">–†–µ—à–µ–Ω–æ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row">
                <div class="col-md-4">
                    <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="new" {% if status_filter == 'new' %}selected{% endif %}>–ù–æ–≤—ã–µ</option>
                        <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>–†–µ—à–µ–Ω–æ</option>
                        <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>–ó–∞–∫—Ä—ã—Ç–æ</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="type" class="form-label">–¢–∏–ø</label>
                    <select name="type" id="type" class="form-select">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                        <option value="bug" {% if type_filter == 'bug' %}selected{% endif %}>üêõ –û—à–∏–±–∫–∞</option>
                        <option value="feature" {% if type_filter == 'feature' %}selected{% endif %}>üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</option>
                        <option value="general" {% if type_filter == 'general' %}selected{% endif %}>üí¨ –û–±—â–µ–µ</option>
                        <option value="other" {% if type_filter == 'other' %}selected{% endif %}>üìù –î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
                    <a href="{{ url_for('feedback_list') }}" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                </div>
            </form>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π -->
    <div class="card">
        <div class="card-body">
            {% if feedback.items %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–¢–∏–ø</th>
                            <th>–¢–µ–º–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in feedback.items %}
                        <tr>
                            <td>{{ item.id }}</td>
                            <td>
                                <strong>{{ item.user.first_name }}</strong>
                                {% if item.user.last_name %}{{ item.user.last_name }}{% endif %}
                                <br>
                                <small class="text-muted">ID: {{ item.user.telegram_id }}</small>
                            </td>
                            <td>
                                {% if item.feedback_type == 'bug' %}üêõ –û—à–∏–±–∫–∞
                                {% elif item.feedback_type == 'feature' %}üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                                {% elif item.feedback_type == 'general' %}üí¨ –û–±—â–µ–µ
                                {% else %}üìù –î—Ä—É–≥–æ–µ{% endif %}
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;" title="{{ item.subject }}">
                                    {{ item.subject }}
                                </div>
                            </td>
                            <td>
                                {% if item.status == 'NEW' or not item.status %}
                                    <span class="badge bg-warning">–ù–æ–≤–æ–µ</span>
                                {% elif item.status == 'IN_PROGRESS' %}
                                    <span class="badge bg-info">–í —Ä–∞–±–æ—Ç–µ</span>
                                {% elif item.status == 'RESOLVED' %}
                                    <span class="badge bg-success">–†–µ—à–µ–Ω–æ</span>
                                {% elif item.status == 'CLOSED' %}
                                    <span class="badge bg-secondary">–ó–∞–∫—Ä—ã—Ç–æ</span>
                                {% else %}
                                    <span class="badge bg-warning">–ù–æ–≤–æ–µ</span>
                                {% endif %}
                            </td>
                            <td>{{ item.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            <td>
                                <a href="{{ url_for('feedback_detail', feedback_id=item.id) }}" 
                                   class="btn btn-sm btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            {% if feedback.pages > 1 %}
            <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
                <ul class="pagination justify-content-center">
                    {% if feedback.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('feedback_list', page=feedback.prev_num, status=status_filter, type=type_filter) }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in feedback.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != feedback.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('feedback_list', page=page_num, status=status_filter, type=type_filter) }}">{{ page_num }}</a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if feedback.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('feedback_list', page=feedback.next_num, status=status_filter, type=type_filter) }}">–°–ª–µ–¥—É—é—â–∞—è</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            
            {% else %}
            <div class="text-center py-4">
                <p class="text-muted">–û–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
