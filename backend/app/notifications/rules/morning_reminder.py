from __future__ import annotations

from datetime import timedelta, date, datetime, timezone
from typing import Dict, Any, Iterable

from app.core.config import settings
from app.core.database import SessionLocal
from app.models import User, Pair, Mood, UserAnswer, UsageEvent
from ..base import ScheduledTrigger, Rule, register_rule, msk_to_utc_cron


class MorningReminderRule:
    id = "morning_reminder"
    trigger = ScheduledTrigger(cron=msk_to_utc_cron(10, 0))  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00 MSK
    priority = 90

    def select_targets(self, ctx: Dict[str, Any]) -> Iterable[User]:
        session = SessionLocal()
        try:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –ø–∞—Ä–∞
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º UNION –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è user1 –∏ user2 –∏–∑ –ø–∞—Ä
            from sqlalchemy import or_
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è user1 –∏–ª–∏ user2 –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä–∞—Ö
            users_with_pairs = session.query(User).join(
                Pair, 
                or_(User.id == Pair.user1_id, User.id == Pair.user2_id)
            ).filter(Pair.status == "active").all()
            
            return users_with_pairs
        finally:
            session.close()

    def is_allowed(self, ctx: Dict[str, Any], user: User) -> bool:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ö–æ–¥–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —á–∞—Å–∞
        session = SessionLocal()
        try:
            four_hours_ago = datetime.now(timezone.utc) - timedelta(hours=4)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ UsageEvent –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —á–∞—Å–∞
            recent_activity = session.query(UsageEvent).filter(
                UsageEvent.telegram_id == user.telegram_id,
                UsageEvent.ts >= four_hours_ago
            ).first()
            
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —á–∞—Å–∞, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
            return not recent_activity
            
        finally:
            session.close()

    def cooldown(self):
        return timedelta(hours=24)

    def make_dedupe(self, ctx: Dict[str, Any], user: User) -> Dict[str, Any]:
        return {"entity_type": None, "entity_id": None, "date_bucket": date.today().isoformat()}

    def render(self, ctx: Dict[str, Any], user: User) -> Dict[str, Any]:
        webapp_base_url = settings.TELEGRAM_WEBAPP_URL or "https://gallery.homoludens.photos/pulse_of_pair/"
        webapp_url = f"{webapp_base_url}?tgWebAppStartParam=main"
        
        import random
        greetings = [
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ó–∞–≥–ª—è–Ω–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –≤–¥—Ä—É–≥ —Ç–∞–º –Ω–∞–π–¥—ë—Ç—Å—è —Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–¥–µ–ª–∞–µ—Ç –¥–µ–Ω—å —Ç–µ–ø–ª–µ–µ.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —É–∂–µ –∂–¥—ë—Ç —á—Ç–æ-—Ç–æ, —á—Ç–æ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –æ—Å–æ–±–µ–Ω–Ω—ã–º.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ü–∞—Ä–∞ –º–∏–Ω—É—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –∏ —É –≤–∞—Å –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–≤–æ–¥ —É–ª—ã–±–Ω—É—Ç—å—Å—è –¥—Ä—É–≥ –¥—Ä—É–≥—É.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –Ω–∞—á–∞–ª–æ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –°–µ–≥–æ–¥–Ω—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤–∞—Å –∂–¥—ë—Ç —á—Ç–æ-—Ç–æ –¥–ª—è –≤–∞—à–µ–π –ø–∞—Ä—ã.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ó–∞–≥–ª—è–Ω–∏—Ç–µ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–º –Ω–∞–π–¥—ë—Ç—Å—è –∏–¥–µ—è –¥–ª—è —Ç—ë–ø–ª–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ —Å–µ–≥–æ–¥–Ω—è.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ù–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –∏ –¥–µ–Ω—å –Ω–∞—á–Ω—ë—Ç—Å—è —Å –º–∞–ª–µ–Ω—å–∫–æ–≥–æ, –Ω–æ –≤–∞–∂–Ω–æ–≥–æ –∂–µ—Å—Ç–∞.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –°–µ–≥–æ–¥–Ω—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å –ø–æ–≤–æ–¥ –¥–ª—è –Ω–æ–≤–æ–π —É–ª—ã–±–∫–∏.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ú–æ–∂–µ—Ç –±—ã—Ç—å, —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –≤–æ–ø—Ä–æ—Å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Å—Ç–∞–Ω–µ—Ç –≤–∞—à–∏–º –º–∞–ª–µ–Ω—å–∫–∏–º –æ—Ç–∫—Ä—ã—Ç–∏–µ–º.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤–∞—Å –∂–¥—ë—Ç —Ç–µ–º–∞, –æ –∫–æ—Ç–æ—Ä–æ–π —Å—Ç–æ–∏—Ç –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ó–∞–≥–ª—è–Ω–∏—Ç–µ ‚Äî —Ç–∞–º –µ—Å—Ç—å —á—Ç–æ-—Ç–æ, —á—Ç–æ –º–æ–∂–µ—Ç —Å–∫—Ä–∞—Å–∏—Ç—å —É—Ç—Ä–æ.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ü–∞—Ä–∞ –º–∏–Ω—É—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –∏ –¥–µ–Ω—å –ø–æ–ª—É—á–∏—Ç –Ω–µ–º–Ω–æ–≥–æ —Ç–µ–ø–ª–∞.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –°–µ–≥–æ–¥–Ω—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤–∞—Å –∂–¥—ë—Ç –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —É–¥–∏–≤–∏—Ç—å.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –≤–¥—Ä—É–≥ —Ç–∞–º –µ—Å—Ç—å –∏–¥–µ—è –¥–ª—è –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –≤–µ—á–µ—Ä–∞.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å –Ω–µ–±–æ–ª—å—à–æ–π —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —É–∂–µ –≥–æ—Ç–æ–≤ –≤–æ–ø—Ä–æ—Å –¥–ª—è –≤–∞—Å –¥–≤–æ–∏—Ö.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –í–æ–∑–º–æ–∂–Ω–æ, –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤—ã –Ω–∞–π–¥—ë—Ç–µ —Ç–µ–º—É –¥–ª—è –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –°–µ–≥–æ–¥–Ω—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å —Ç–æ, —á—Ç–æ –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–ø–ª–∞ –≤–∞—à–µ–º—É –¥–Ω—é.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ó–∞–≥–ª—è–Ω–∏—Ç–µ ‚Äî —Ç–∞–º –≤–∞—Å –∂–¥—ë—Ç –º–∞–ª–µ–Ω—å–∫–∏–π –ø–æ–≤–æ–¥ –¥–ª—è —É–ª—ã–±–∫–∏.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ü–∞—Ä–∞ –º–∏–Ω—É—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –∏ —É –≤–∞—Å –ø–æ—è–≤–∏—Ç—Å—è –Ω–æ–≤–∞—è –æ–±—â–∞—è —Ç–µ–º–∞.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –≤–æ–ø—Ä–æ—Å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –Ω–∞—á–∞–ª–æ–º —á–µ–≥–æ-—Ç–æ –≤–∞–∂–Ω–æ–≥–æ.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ó–∞–≥–ª—è–Ω–∏—Ç–µ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–º –µ—Å—Ç—å –∏–¥–µ—è, –∫–æ—Ç–æ—Ä—É—é –≤—ã –∑–∞—Ö–æ—Ç–∏—Ç–µ –æ–±—Å—É–¥–∏—Ç—å.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ù–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –∏ –¥–µ–Ω—å –Ω–∞—á–Ω—ë—Ç—Å—è –∏–Ω–∞—á–µ.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤–∞—Å –∂–¥—ë—Ç –º–∞–ª–µ–Ω—å–∫–∞—è –¥–µ—Ç–∞–ª—å, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –°–µ–≥–æ–¥–Ω—è —Ç–∞–º –µ—Å—Ç—å —á—Ç–æ-—Ç–æ, —á—Ç–æ —Å—Ç–æ–∏—Ç –æ–±—Å—É–¥–∏—Ç—å –∏–º–µ–Ω–Ω–æ –≤–∞–º –¥–≤–æ–∏–º.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ–≥–æ–¥–Ω—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤—ã –Ω–∞–π–¥—ë—Ç–µ —á—Ç–æ-—Ç–æ, —á—Ç–æ –≤–∞—Å —Å–±–ª–∏–∑–∏—Ç.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —É–∂–µ –∂–¥—ë—Ç –≤–æ–ø—Ä–æ—Å –¥–ª—è –≤–∞—à–µ–≥–æ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ù–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–æ–≥—É—Ç –ø–æ–¥–∞—Ä–∏—Ç—å –Ω–æ–≤—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –ø—Ä–∏–≤—ã—á–Ω—ã–µ –≤–µ—â–∏.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –°–µ–≥–æ–¥–Ω—è —Ç–∞–º –µ—Å—Ç—å —Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–µ—Ç–∞ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ó–∞–≥–ª—è–Ω–∏—Ç–µ ‚Äî –≤–¥—Ä—É–≥ –∏–º–µ–Ω–Ω–æ —Å–µ–≥–æ–¥–Ω—è –≤–∞—Å –∂–¥—ë—Ç —á—Ç–æ-—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ–µ."
        ]
        text = "üåÖ " + random.choice(greetings)
        
        reply_markup = {
            "inline_keyboard": [
                [
                    {"text": "–û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "web_app": {"url": f"{webapp_base_url}?tgWebAppStartParam=mood"}},
                    {"text": "–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å", "web_app": {"url": f"{webapp_base_url}?tgWebAppStartParam=questions"}}
                ],
                [
                    {"text": "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", "web_app": {"url": webapp_url}}
                ]
            ]
        }
        
        return {"text": text, "reply_markup": reply_markup}


# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è
register_rule(MorningReminderRule())


